"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DynamoError = exports.DynamoClient = void 0;

var _logger = require("../../commons/util/logger");

var _awsSdk = _interopRequireDefault(require("aws-sdk"));

var _amazonDaxClient = _interopRequireDefault(require("amazon-dax-client"));

var _dynamodb = require("aws-sdk/clients/dynamodb");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const p = (0, _logger.logD)(__filename);
if (process.env.NODE_ENV === 'development') _awsSdk.default.config.logger = console;
/**
 * DynamoDB access client.
 * Using DocumentClient.
 */

class DynamoClient {
  // public for test

  /**
   * @param config aws config
   */
  constructor(config, dax) {
    _defineProperty(this, "db", void 0);

    _awsSdk.default.config.update(config);

    this.db = dax ? new _dynamodb.DocumentClient({
      service: new _amazonDaxClient.default({
        endpoints: dax.endpoints,
        region: dax.region
      })
    }) : new _dynamodb.DocumentClient();
  }
  /**
   * Put a single object.
   * @param params
   * @returns
   */


  async putItemSync(params) {
    try {
      return await this.db.put(params).promise();
    } catch (error) {
      throw new DynamoError(error);
    }
  }
  /**
   * Put a single object.
   * @param params
   * @param cb
   * @returns
   */


  putItem(params, cb) {
    this.db.put(params, (e, data) => {
      e ? cb(new DynamoError(e)) : cb(undefined, data);
    });
  }
  /**
   * Update a single object.
   * @param params
   * @returns
   */


  async updateItemSync(params) {
    try {
      return await this.db.update(params).promise();
    } catch (error) {
      throw new DynamoError(error);
    }
  }
  /**
   * Update a single object.
   * @param params
   * @param cb
   * @returns
   */


  updateItem(params, cb) {
    this.db.update(params, (e, data) => {
      e ? cb(new DynamoError(e)) : cb(undefined, data);
    });
  }
  /**
   * Get by the key.
   * @param params
   * @returns
   */


  async getItemSync(params) {
    try {
      const data = await this.db.get(params).promise();
      return data.Item;
    } catch (error) {
      throw new DynamoError(error);
    }
  }
  /**
   * Get by the key.
   * @param params
   * @param cb
   * @returns
   */


  getItem(params, cb) {
    this.db.get(params, (e, data) => {
      e ? cb(new DynamoError(e)) : cb(undefined, data.Item);
    });
  }
  /**
   * Run query.
   * @param params
   * @returns
   */


  async queryTableSync(params) {
    try {
      const data = await this.db.query(params).promise();
      return data.Items;
    } catch (error) {
      throw new DynamoError(error);
    }
  }
  /**
   * Run query.
   * @param params
   * @param
   * @returns
   */


  queryTable(params, cb) {
    this.db.query(params, (e, data) => {
      e ? cb(new DynamoError(e)) : cb(undefined, data.Items);
    });
  }
  /**
   * Run scan.
   * @param params
   * @returns
   */


  async scanTableSync(params) {
    try {
      const data = await this.db.scan(params).promise();
      return data.Items;
    } catch (error) {
      throw new DynamoError(error);
    }
  }
  /**
   * Run scan.
   * @param params
   * @param
   * @returns
   */


  scanTable(params, cb) {
    this.db.scan(params, (e, data) => {
      e ? cb(new DynamoError(e)) : cb(undefined, data.Items);
    });
  }
  /**
   * Delete a single object.
   * @param params
   * @returns
   */


  async deleteItemSync(params) {
    try {
      return await this.db.delete(params).promise();
    } catch (error) {
      throw new DynamoError(error);
    }
  }
  /**
   * Delete a single object.
   * @param params
   * @param cb
   * @returns
   */


  deleteItem(params, cb) {
    this.db.delete(params, (e, data) => {
      e ? cb(new DynamoError(e)) : cb(undefined, data);
    });
  }

}
/**
 * Module error class.
 */


exports.DynamoClient = DynamoClient;

class DynamoError extends Error {
  /**
   * @param error_object
   */
  constructor(error_object) {
    super(error_object.message);

    _defineProperty(this, "statusCode", void 0);

    this.message = error_object.message;
    this.statusCode = 500;
  }

}

exports.DynamoError = DynamoError;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kcml2ZXJzL2R5bmFtby9EeW5hbW9DbGllbnQudHMiXSwibmFtZXMiOlsicCIsIl9fZmlsZW5hbWUiLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJBV1MiLCJjb25maWciLCJsb2dnZXIiLCJjb25zb2xlIiwiRHluYW1vQ2xpZW50IiwiY29uc3RydWN0b3IiLCJkYXgiLCJ1cGRhdGUiLCJkYiIsIkRvY3VtZW50Q2xpZW50Iiwic2VydmljZSIsIkFtYXpvbkRheENsaWVudCIsImVuZHBvaW50cyIsInJlZ2lvbiIsInB1dEl0ZW1TeW5jIiwicGFyYW1zIiwicHV0IiwicHJvbWlzZSIsImVycm9yIiwiRHluYW1vRXJyb3IiLCJwdXRJdGVtIiwiY2IiLCJlIiwiZGF0YSIsInVuZGVmaW5lZCIsInVwZGF0ZUl0ZW1TeW5jIiwidXBkYXRlSXRlbSIsImdldEl0ZW1TeW5jIiwiZ2V0IiwiSXRlbSIsImdldEl0ZW0iLCJxdWVyeVRhYmxlU3luYyIsInF1ZXJ5IiwiSXRlbXMiLCJxdWVyeVRhYmxlIiwic2NhblRhYmxlU3luYyIsInNjYW4iLCJzY2FuVGFibGUiLCJkZWxldGVJdGVtU3luYyIsImRlbGV0ZSIsImRlbGV0ZUl0ZW0iLCJFcnJvciIsImVycm9yX29iamVjdCIsIm1lc3NhZ2UiLCJzdGF0dXNDb2RlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQWFBLE1BQU1BLENBQUMsR0FBRyxrQkFBS0MsVUFBTCxDQUFWO0FBQ0EsSUFBSUMsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFFBQVosS0FBeUIsYUFBN0IsRUFBNENDLGdCQUFJQyxNQUFKLENBQVdDLE1BQVgsR0FBb0JDLE9BQXBCO0FBRTVDOzs7OztBQUlBLE1BQU1DLFlBQU4sQ0FBbUI7QUFDVTs7QUFDM0I7OztBQUdBQyxFQUFBQSxXQUFXLENBQUNKLE1BQUQsRUFBaUNLLEdBQWpDLEVBQXFGO0FBQUE7O0FBQzlGTixvQkFBSUMsTUFB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O0FBRUQ7Ozs7Ozs7QUFLQSxRQUFNSyxjQUFOLENBQXFCdkIsTUFBckIsRUFBeUU7QUFDdkUsUUFBSTtBQUNGLGFBQU8sTUFBTSxLQUFLUCxFQUFMLENBQVErQixNQUFSLENBQWV4QixNQUFmLEVBQXVCRSxPQUF2QixFQUFiO0FBQ0QsS0FGRCxDQUVFLE9BQU9DLEtBQVAsRUFBYztBQUNkLFlBQU0sSUFBSUMsV0FBSixDQUFnQkQsS0FBaEIsQ0FBTjtBQUNEO0FBQ0Y7QUFFRDs7Ozs7Ozs7QUFNQXNCLEVBQUFBLFVBQVUsQ0FBQ3pCLE1BQUQsRUFBMEJNLEVBQTFCLEVBQTRGO0FBQ3BHLFNBQUtiLEVBQUwsQ0FBUStCLE1BQVIsQ0FBZXhCLE1BQWYsRUFBdUIsQ0FBQ08sQ0FBRCxFQUFJQyxJQUFKLEtBQWE7QUFDbENELE1BQUFBLENBQUMsR0FBR0QsRUFBRSxDQUFDLElBQUlGLFdBQUosQ0FBZ0JHLENBQWhCLENBQUQsQ0FBTCxHQUE0QkQsRUFBRSxDQUFDRyxTQUFELEVBQVlELElBQVosQ0FBL0I7QUFDRCxLQUZEO0FBR0Q7O0FBdEtnQjtBQXlLbkI7Ozs7Ozs7QUFHQSxNQUFNSixXQUFOLFNBQTBCc0IsS0FBMUIsQ0FBZ0M7QUFFOUI7OztBQUdBcEMsRUFBQUEsV0FBVyxDQUFDcUMsWUFBRCxFQUFzQjtBQUMvQixVQUFNQSxZQUFZLENBQUNDLE9BQW5COztBQUQrQjs7QUFFL0IsU0FBS0EsT0FBTCxHQUFlRCxZQUFZLENBQUNDLE9BQTVCO0FBQ0EsU0FBS0MsVUFBTCxHQUFrQixHQUFsQjtBQUNEOztBQVQ2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxvZywgbG9nRSwgbG9nRCB9IGZyb20gJy4uLy4uL2NvbW1vbnMvdXRpbC9sb2dnZXInO1xuaW1wb3J0IEFXUyBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCBBbWF6b25EYXhDbGllbnQgZnJvbSAnYW1hem9uLWRheC1jbGllbnQnO1xuaW1wb3J0IHtcbiAgRG9jdW1lbnRDbGllbnQsXG4gIFB1dEl0ZW1JbnB1dCxcbiAgUHV0SXRlbU91dHB1dCxcbiAgR2V0SXRlbUlucHV0LFxuICBRdWVyeUlucHV0LFxuICBTY2FuSW5wdXQsXG4gIERlbGV0ZUl0ZW1JbnB1dCxcbiAgRGVsZXRlSXRlbU91dHB1dCxcbiAgSXRlbUxpc3QsXG4gIFVwZGF0ZUl0ZW1JbnB1dCxcbiAgVXBkYXRlSXRlbU91dHB1dCxcbn0gZnJvbSAnYXdzLXNkay9jbGllbnRzL2R5bmFtb2RiJztcbmNvbnN0IHAgPSBsb2dEKF9fZmlsZW5hbWUpO1xuaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnKSBBV1MuY29uZmlnLmxvZ2dlciA9IGNvbnNvbGU7XG5cbi8qKlxuICogRHluYW1vREIgYWNjZXNzIGNsaWVudC5cbiAqIFVzaW5nIERvY3VtZW50Q2xpZW50LlxuICovXG5jbGFzcyBEeW5hbW9DbGllbnQge1xuICBwdWJsaWMgZGI6IERvY3VtZW50Q2xpZW50OyAvLyBwdWJsaWMgZm9yIHRlc3RcbiAgLyoqXG4gICAqIEBwYXJhbSBjb25maWcgYXdzIGNvbmZpZ1xuICAgKi9cbiAgY29uc3RydWN0b3IoY29uZmlnOiB7IFtrZXk6IHN0cmluZ106IGFueSB9LCBkYXg/OiB7IGVuZHBvaW50czogQXJyYXk8c3RyaW5nPjsgcmVnaW9uOiBzdHJpbmcgfSkge1xuICAgIEFXUy5jb25maWcudXBkYXRlKGNvbmZpZyk7XG5cbiAgICB0aGlzLmRiID0gZGF4XG4gICAgICA/IG5ldyBEb2N1bWVudENsaWVudCh7IHNlcnZpY2U6IG5ldyBBbWF6b25EYXhDbGllbnQoeyBlbmRwb2ludHM6IGRheC5lbmRwb2ludHMsIHJlZ2lvbjogZGF4LnJlZ2lvbiB9KSB9KVxuICAgICAgOiBuZXcgRG9jdW1lbnRDbGllbnQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQdXQgYSBzaW5nbGUgb2JqZWN0LlxuICAgKiBAcGFyYW0gcGFyYW1zXG4gICAqIEByZXR1cm5zXG4gICAqL1xuICBhc3luYyBwdXRJdGVtU3luYyhwYXJhbXM6IFB1dEl0ZW1JbnB1dCk6IFByb21pc2U8UHV0SXRlbU91dHB1dD4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5kYi5wdXQocGFyYW1zKS5wcm9taXNlKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBEeW5hbW9FcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFB1dCBhIHNpbmdsZSBvYmplY3QuXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICogQHBhcmFtIGNiXG4gICAqIEByZXR1cm5zXG4gICAqL1xuICBwdXRJdGVtKHBhcmFtczogUHV0SXRlbUlucHV0LCBjYjogKGVycj86IER5bmFtb0Vycm9yLCByZXN1bHQ/OiBQdXRJdGVtT3V0cHV0KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdGhpcy5kYi5wdXQocGFyYW1zLCAoZSwgZGF0YSkgPT4ge1xuICAgICAgZSA/IGNiKG5ldyBEeW5hbW9FcnJvcihlKSkgOiBjYih1bmRlZmluZWQsIGRhdGEpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBhIHNpbmdsZSBvYmplY3QuXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICogQHJldHVybnNcbiAgICovXG4gIGFzeW5jIHVwZGF0ZUl0ZW1TeW5jKHBhcmFtczogVXBkYXRlSXRlbUlucHV0KTogUHJvbWlzZTxVcGRhdGVJdGVtT3V0cHV0PiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmRiLnVwZGF0ZShwYXJhbXMpLnByb21pc2UoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IER5bmFtb0Vycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIGEgc2luZ2xlIG9iamVjdC5cbiAgICogQHBhcmFtIHBhcmFtc1xuICAgKiBAcGFyYW0gY2JcbiAgICogQHJldHVybnNcbiAgICovXG4gIHVwZGF0ZUl0ZW0ocGFyYW1zOiBVcGRhdGVJdGVtSW5wdXQsIGNiOiAoZXJyPzogRHluYW1vRXJyb3IsIHJlc3VsdD86IFB1dEl0ZW1PdXRwdXQpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLmRiLnVwZGF0ZShwYXJhbXMsIChlLCBkYXRhKSA9PiB7XG4gICAgICBlID8gY2IobmV3IER5bmFtb0Vycm9yKGUpKSA6IGNiKHVuZGVmaW5lZCwgZGF0YSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGJ5IHRoZSBrZXkuXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICogQHJldHVybnNcbiAgICovXG4gIGFzeW5jIGdldEl0ZW1TeW5jKHBhcmFtczogR2V0SXRlbUlucHV0KTogUHJvbWlzZTxvYmplY3QgfCB1bmRlZmluZWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuZGIuZ2V0KHBhcmFtcykucHJvbWlzZSgpO1xuICAgICAgcmV0dXJuIGRhdGEuSXRlbTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IER5bmFtb0Vycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGJ5IHRoZSBrZXkuXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICogQHBhcmFtIGNiXG4gICAqIEByZXR1cm5zXG4gICAqL1xuICBnZXRJdGVtKHBhcmFtczogR2V0SXRlbUlucHV0LCBjYjogKGVycj86IER5bmFtb0Vycm9yLCByZXN1bHQ/OiBvYmplY3QpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLmRiLmdldChwYXJhbXMsIChlLCBkYXRhKSA9PiB7XG4gICAgICBlID8gY2IobmV3IER5bmFtb0Vycm9yKGUpKSA6IGNiKHVuZGVmaW5lZCwgZGF0YS5JdGVtKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gcXVlcnkuXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICogQHJldHVybnNcbiAgICovXG4gIGFzeW5jIHF1ZXJ5VGFibGVTeW5jKHBhcmFtczogUXVlcnlJbnB1dCk6IFByb21pc2U8SXRlbUxpc3QgfCB1bmRlZmluZWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuZGIucXVlcnkocGFyYW1zKS5wcm9taXNlKCk7XG5cbiAgICAgIHJldHVybiBkYXRhLkl0ZW1zO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRHluYW1vRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gcXVlcnkuXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICogQHBhcmFtXG4gICAqIEByZXR1cm5zXG4gICAqL1xuICBxdWVyeVRhYmxlKHBhcmFtczogUXVlcnlJbnB1dCwgY2I6IChlcnI/OiBEeW5hbW9FcnJvciwgcmVzdWx0Pzogb2JqZWN0KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdGhpcy5kYi5xdWVyeShwYXJhbXMsIChlLCBkYXRhKSA9PiB7XG4gICAgICBlID8gY2IobmV3IER5bmFtb0Vycm9yKGUpKSA6IGNiKHVuZGVmaW5lZCwgZGF0YS5JdGVtcyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUnVuIHNjYW4uXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICogQHJldHVybnNcbiAgICovXG4gIGFzeW5jIHNjYW5UYWJsZVN5bmMocGFyYW1zOiBTY2FuSW5wdXQpOiBQcm9taXNlPEl0ZW1MaXN0IHwgdW5kZWZpbmVkPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLmRiLnNjYW4ocGFyYW1zKS5wcm9taXNlKCk7XG5cbiAgICAgIHJldHVybiBkYXRhLkl0ZW1zO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRHluYW1vRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gc2Nhbi5cbiAgICogQHBhcmFtIHBhcmFtc1xuICAgKiBAcGFyYW1cbiAgICogQHJldHVybnNcbiAgICovXG4gIHNjYW5UYWJsZShwYXJhbXM6IFNjYW5JbnB1dCwgY2I6IChlcnI/OiBEeW5hbW9FcnJvciwgcmVzdWx0Pzogb2JqZWN0KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdGhpcy5kYi5zY2FuKHBhcmFtcywgKGUsIGRhdGEpID0+IHtcbiAgICAgIGUgPyBjYihuZXcgRHluYW1vRXJyb3IoZSkpIDogY2IodW5kZWZpbmVkLCBkYXRhLkl0ZW1zKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUgYSBzaW5nbGUgb2JqZWN0LlxuICAgKiBAcGFyYW0gcGFyYW1zXG4gICAqIEByZXR1cm5zXG4gICAqL1xuICBhc3luYyBkZWxldGVJdGVtU3luYyhwYXJhbXM6IERlbGV0ZUl0ZW1JbnB1dCk6IFByb21pc2U8RGVsZXRlSXRlbU91dHB1dD4ge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5kYi5kZWxldGUocGFyYW1zKS5wcm9taXNlKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBEeW5hbW9FcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBhIHNpbmdsZSBvYmplY3QuXG4gICAqIEBwYXJhbSBwYXJhbXNcbiAgICogQHBhcmFtIGNiXG4gICAqIEByZXR1cm5zXG4gICAqL1xuICBkZWxldGVJdGVtKHBhcmFtczogRGVsZXRlSXRlbUlucHV0LCBjYjogKGVycj86IER5bmFtb0Vycm9yLCByZXN1bHQ/OiBEZWxldGVJdGVtT3V0cHV0KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdGhpcy5kYi5kZWxldGUocGFyYW1zLCAoZSwgZGF0YSkgPT4ge1xuICAgICAgZSA/IGNiKG5ldyBEeW5hbW9FcnJvcihlKSkgOiBjYih1bmRlZmluZWQsIGRhdGEpO1xuICAgIH0pO1xuICB9XG59XG5cbi8qKlxuICogTW9kdWxlIGVycm9yIGNsYXNzLlxuICovXG5jbGFzcyBEeW5hbW9FcnJvciBleHRlbmRzIEVycm9yIHtcbiAgcHVibGljIHN0YXR1c0NvZGU6IG51bWJlcjtcbiAgLyoqXG4gICAqIEBwYXJhbSBlcnJvcl9vYmplY3RcbiAgICovXG4gIGNvbnN0cnVjdG9yKGVycm9yX29iamVjdDogRXJyb3IpIHtcbiAgICBzdXBlcihlcnJvcl9vYmplY3QubWVzc2FnZSk7XG4gICAgdGhpcy5tZXNzYWdlID0gZXJyb3Jfb2JqZWN0Lm1lc3NhZ2U7XG4gICAgdGhpcy5zdGF0dXNDb2RlID0gNTAwO1xuICB9XG59XG5cbmV4cG9ydCB7IER5bmFtb0NsaWVudCwgRHluYW1vRXJyb3IgfTtcbiJdfQ==